<!DOCTYPE html>
<html>
<head>
  <title>getTLIdEncoderDecoder.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="doc-style.css" />
  <script src="doc-filelist.js"></script>
  <script>
    var relativeDir = "", thisFile = "home/fozz/Projects/syncit//getTLIdEncoderDecoder.js", defaultSidebar = true;
  </script>
  <script src="doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#gettlidencoderdecoder()">getTLIdEncoderDecoder()</a>
      </div>
      <div class="heading h2">
        <a href="#parameters">Parameters</a>
      </div>
      <div class="heading h2">
        <a href="#example">Example</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>getTLIdEncoderDecoder.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="cm">/*jshint smarttabs:true */</span>
<span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
  <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">exports</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Node. Does not work with strict CommonJS, but
only CommonJS-like enviroments that support module.exports,
like Node.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>AMD. Register as an anonymous module.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">define</span><span class="p">([],</span><span class="nx">factory</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Browser globals (root is window)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">root</span><span class="p">.</span><span class="nx">SyncIt_getTLIdEncoderDecoder</span> <span class="o">=</span> <span class="nx">factory</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">})(</span><span class="k">this</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

<span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Author: Matthew Forrester <matt_at_keyboardwritescode.com>
Copyright: Matthew Forrester
License: MIT/BSD-style</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gettlidencoderdecoder()">
  <h1>
    <a href="#gettlidencoderdecoder()" name="gettlidencoderdecoder()" class="pilcrow">&#182;</a>
    getTLIdEncoderDecoder()
  </h1>
</div>

  </div>
  <div class="body"><p>Generate time based local Id's which are guarenteed to be unique for that
particular constructor call.</p>


<div class="pilwrap" id="parameters">
  <h2>
    <a href="#parameters" name="parameters" class="pilcrow">&#182;</a>
    Parameters
  </h2>
</div>


<ul>
<li><strong>@param {Number} <code>epoch</code></strong> A timestamp, all unique Id's will use this as
thier base time.</li>
<li><strong>@param {Number} <code>uniqueLength</code></strong> Id's will be based on a timestamp and a
extra sequence number if we happen to generate two Id's in the same 
millisecond. If you leave this at the default of 1, 32 unique Id's can be
generated per millisecond (because it's a 32bit number represented in a
string), I have found this to be sufficient, but you can increase this
number if it is not.</li>
<li><strong>@return {Object} <code>return</code></strong> The return value includes three seperate Functions, 
these are:</li>
<li><strong>@return {Function} <code>return.encode</code></strong> Encode now by default (or the
first parameter) into an Id.</li>
<li><strong>@return {Function} <code>return.decode</code></strong> Decode an Id back into a 
timestamp (Id is the first parameter).</li>
<li><strong>@return {Function} <code>return.sort</code></strong> Compatible with Array.sort() and
will soft based on the encode time / first parameter.</li>
</ul>


<div class="pilwrap" id="example">
  <h2>
    <a href="#example" name="example" class="pilcrow">&#182;</a>
    Example
  </h2>
</div>



<div class="highlight"><pre><code><span class="c1">// Use one character (32 bit number) to ensure uniqueness within a millisecond</span>
<span class="kd">var</span> <span class="nx">uniquenessPerMillisecond</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="c1">// As close as possible (but lower) than the lowest date to give shorter Id&#39;s</span>
<span class="kd">var</span> <span class="nx">epoch</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1970</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">).</span><span class="nx">getTime</span><span class="p">();</span>

<span class="c1">// Get the TLId Encoder / Decoder</span>
<span class="kd">var</span> <span class="nx">encoderDecoder</span> <span class="o">=</span> <span class="nx">getTLIdEncoderDecoder</span><span class="p">(</span><span class="nx">epoch</span><span class="p">,</span><span class="nx">uniquenessPerMillisecond</span><span class="p">);</span>

<span class="c1">// Encode a date into a unique string</span>
<span class="kd">var</span> <span class="nx">dates</span> <span class="o">=</span> <span class="p">[</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(),</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()),</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1981</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">15</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()),</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1986</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()),</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1983</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()),</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">1982</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">).</span><span class="nx">getTime</span><span class="p">()),</span>
  <span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">()</span>
<span class="p">];</span>

<span class="c1">// Get the dates it was encoded</span>
<span class="kd">var</span> <span class="nx">originalTimestamps</span> <span class="o">=</span> <span class="nx">dates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">);</span>

<span class="c1">// Sort them in date order</span>
<span class="kd">var</span> <span class="nx">sortedDates</span> <span class="o">=</span> <span class="nx">dates</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">sort</span><span class="p">);</span><span class="o">*</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;The first Date is &quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">encoderDecoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">sortedDates</span><span class="p">[</span><span class="mi">0</span><span class="p">])));</span>
</code></pre></div>


  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">epoch</span><span class="p">,</span><span class="nx">uniqueLength</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="kd">var</span> <span class="nx">lastDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">uniqueLength</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">uniqueLength</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">epoch</span> <span class="o">!=</span> <span class="s1">&#39;number&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="s2">&quot;Only takes timestamps&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">genUid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">now</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;Only takes timestamps&quot;</span><span class="p">;</span>
  <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">((</span><span class="nx">lastDate</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">now</span> <span class="o">!==</span> <span class="nx">lastDate</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">superUnique</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="nx">index</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">superUnique</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">uniqueLength</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">superUnique</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">superUnique</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">timeEncoded</span> <span class="o">=</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">epoch</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">superUnique</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">uniqueLength</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="s2">&quot;getUidGenerator.genUid cannot generate TLId until next millisecond!&quot;</span><span class="p">;</span>
  <span class="p">}</span>

    <span class="nx">lastDate</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">timeEncoded</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="s1">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;X&quot;</span><span class="o">+</span><span class="nx">timeEncoded</span><span class="o">+</span><span class="nx">superUnique</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">timeEncoded</span><span class="o">+</span><span class="nx">superUnique</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="kd">var</span> <span class="nx">uidToTimestamp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tlid</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">tlid</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tlid</span> <span class="o">=</span> <span class="nx">tlid</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">tlid</span> <span class="o">=</span> <span class="nx">tlid</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">tlid</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">uniqueLength</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">tlid</span><span class="p">,</span><span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="nx">epoch</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">tlidA</span><span class="p">,</span> <span class="nx">tlidB</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">tlidA</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tlidA</span> <span class="o">=</span> <span class="nx">tlidA</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">tlidB</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">tlidB</span> <span class="o">=</span> <span class="nx">tlidB</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">tlidA</span> <span class="o">=</span> <span class="nx">tlidA</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/.*\./</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="nx">tlidB</span> <span class="o">=</span> <span class="nx">tlidB</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/.*\./</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">tlidA</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">tlidB</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">tlidA</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">tlidB</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">tlidA</span> <span class="o">&lt;</span> <span class="nx">tlidB</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">};</span>
  
  <span class="k">return</span> <span class="p">{</span><span class="nx">encode</span><span class="o">:</span> <span class="nx">genUid</span><span class="p">,</span> <span class="nx">decode</span><span class="o">:</span> <span class="nx">uidToTimestamp</span><span class="p">,</span> <span class="nx">sort</span><span class="o">:</span> <span class="nx">sort</span><span class="p">};</span>
<span class="p">};</span>

<span class="p">});</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
